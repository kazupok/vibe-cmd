# ビジネスルール

## 概要

MaterCMSはNotion統合機能を持つコンテンツ管理システムです。以下は本システムの主要なビジネスルールです。

## コアビジネスルール

### 1. ワークスペース管理

- **ワークスペースの作成**
  - 各組織は1つ以上のワークスペースを作成できる
  - ワークスペース名は組織内で一意である必要がある
  - ワークスペースSlugは全システムで一意である必要がある

- **メンバーシップ管理**
  - ワークスペースには複数のユーザーが所属できる
  - ユーザーロールは階層構造（Owner > Admin > Editor > Viewer）
  - Ownerは最低1名必要

### 2. Notion統合

- **統合の設定**
  - 1ワークスペースに対して複数のNotion統合を設定可能
  - 内部統合方式を採用（OAuthは使用しない）
  - 統合トークンは暗号化して保存

- **データ同期**
  - データベースごとに同期頻度を設定可能
  - 最小同期間隔は5分
  - 同期ジョブは重複実行を防ぐ

### 3. API管理

- **APIキー発行**
  - APIキーはワークスペースごとに発行
  - キーには有効期限を設定可能
  - 権限セットによりアクセス範囲を制限

- **レート制限**
  - デフォルト: 1000リクエスト/時間（約0.28リクエスト/秒）
  - プランに応じて上限を変更可能
  - バーストトラフィックに対応する柔軟な制限
  - Notion APIへのリクエストは別途3リクエスト/秒の制限あり

### 4. データ変換

- **変換ルール**
  - Notionのプロパティ型からシステム内部型への変換
  - カスタム変換ルールの定義が可能
  - 変換エラー時のフォールバック処理

### 5. セキュリティ

- **アクセス制御**
  - リソースベースのアクセス制御（RBAC）
  - APIキーベースの認証
  - JWTベースのユーザー認証

- **データ保護**
  - 機密情報（トークン、APIキー）の暗号化
  - 通信の暗号化（HTTPS必須）
  - 監査ログの記録

## ドメイン不変条件

1. **ワークスペース**
   - 削除時は論理削除（ソフトデリート）
   - アクティブなOwnerが0人になることは許可されない

2. **同期ジョブ**
   - 同一データベースに対する同時実行は不可
   - 失敗時は指数バックオフでリトライ

3. **APIキー**
   - 一度発行されたキーは変更不可
   - 無効化されたキーは再有効化不可

## ビジネスプロセス

### ワークスペースのライフサイクル
1. 作成 → アクティブ → 一時停止 → アーカイブ → 削除

### 同期ジョブのライフサイクル
1. スケジュール → 実行中 → 完了/失敗 → 次回スケジュール

### APIキーのライフサイクル
1. 生成 → アクティブ → 期限切れ/無効化 → 削除