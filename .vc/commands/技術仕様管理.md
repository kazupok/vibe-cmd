# 技術仕様管理ワークフロー

## 概要

ドメイン知識の変更を受けて、技術的な実装方針を決定し、仕様として文書化するワークフロー。AI アシスタントがドメイン知識を基に技術仕様の提案を行い、必要な部分のみ確認・調整を行う。

## 前提条件

- ドメイン知識管理ワークフローが完了している
- AI アシスタントがドメイン知識を読み込み済み
- 基本的な技術選定は AI アシスタントが提案

## Phase 1: AI アシスタントによる技術仕様案作成

### 1.1 実装対象の分析

AI アシスタントが以下を自動分析：

- 対象のビジネスルール（BR-XXX）
- 関連するユーザーストーリー
- 影響を受ける既存機能
- 推奨される優先度

### 1.2 技術仕様の初期提案

AI アシスタントが以下を提案：

- アーキテクチャ設計案
- データモデル設計案
- API 設計案
- 実装アプローチ
- 想定されるリスクと対策

## Phase 2: 重要事項の確認

### 2.1 制約条件の確認

**AI アシスタントからの質問**

- 「提案した設計で、パフォーマンス要件（想定 ○○req/s）は問題ないですか？」
- 「データ量は ○○ 件/日を想定していますが、妥当ですか？」
- 「○○ との連携が必要そうですが、アクセス権限はありますか？」

### 2.2 技術選定の確認

**AI アシスタントからの質問**

- 「○○ ライブラリの使用を提案しますが、承認は必要ですか？」
- 「既存の ○○ パターンから逸脱しますが、問題ないですか？」
- 「新しい依存関係（○○）を追加しても良いですか？」

### 2.3 リスクと代替案の確認

**AI アシスタントからの質問**

- 「○○ のリスクがありますが、許容できますか？」
- 「段階的リリースと一括リリース、どちらが良いですか？」
- 「破壊的変更を避けるため ○○ を提案しますが、どうですか？」

## Phase 3: 最終調整と承認

### 3.1 詳細仕様の確定

AI アシスタントが提示した仕様に対して：

- 修正が必要な箇所の指摘
- 追加要件の伝達
- 実装上の懸念点の共有

### 3.2 実装計画の確認

**AI アシスタントからの最終確認**

- 「実装順序は ○○→○○→○○ で良いですか？」
- 「テスト戦略は単体 → 統合 →E2E の順で、重点は ○○ で良いですか？」
- 「○○ 日での実装は現実的ですか？」

## AI アシスタントの出力例

````markdown
## 技術仕様提案

### 対象ドメイン変更

- BR-012: メール送信の 2 要素認証必須化
- 関連 US: US-005（Notion 統合でのセキュリティ強化）
- リビジョン: r3

### 提案する実装方針

#### 1. アーキテクチャ

- **Domain 層**: `TwoFactorAuthentication`値オブジェクト追加
- **Application 層**: 既存の`AuthService`を拡張
- **Infrastructure 層**: `RedisTokenStore`で一時トークン管理

#### 2. データ設計

```sql
-- 新規テーブル
CREATE TABLE two_factor_tokens (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  token VARCHAR(6) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT FALSE
);
```
````

#### 3. API 設計

- `POST /api/auth/2fa/send` - 認証コード送信
- `POST /api/auth/2fa/verify` - 認証コード検証
- 既存の`/api/auth/login`は後方互換性維持

#### 4. 実装順序

1. Domain 層の値オブジェクト実装（2h）
2. Infrastructure 層のトークンストア（3h）
3. Application 層のサービス拡張（4h）
4. API 層の実装（3h）
5. 既存機能との統合（2h）

### 確認事項

1. **Redis 導入について**: セッション管理に Redis を使用しますが、運用体制は整っていますか？
2. **メール送信レート**: 1 分間に ○ 件の 2FA メール送信を想定していますが、制限はありますか？
3. **移行計画**: 既存ユーザーへの 2FA 有効化は段階的に行いますか？

これらの点について確認させてください。

````

## Phase 4: 技術仕様書の出力

### 出力先
- **保存場所**: `.vc/spec/[BR番号]-[機能名].md`
- **例**: `.vc/spec/BR-012-2fa-authentication.md`

### 簡易フォーマット
```markdown
# BR-012: 2要素認証実装

## 変更内容
[ドメイン変更の要約]

## 技術仕様
[AIが生成した実装方針]

## 確認事項
- [ ] 質問1への回答
- [ ] 質問2への回答

---
作成日: YYYY-MM-DD
````

## 実際の流れ

1. **開始**: 「BR-012 の技術仕様を作成してください」
2. **AI 提案**: 技術仕様案を作成して質問
3. **確認**: 重要事項のみ確認
4. **出力**: `.vc/spec/BR-012-2fa-authentication.md`に保存
