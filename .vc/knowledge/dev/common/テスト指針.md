# テスト戦略ガイドライン

## 概要

品質を保証しながら効率的に開発を進めるためのテスト戦略。

## テストピラミッド

### レベル別配分

- **ユニットテスト（70%）**: 個々のクラス・関数の動作確認
- **統合テスト（20%）**: DB 接続、外部 API 連携などの確認
- **E2E テスト（10%）**: 重要なユーザーシナリオの確認

### カバレッジ目標

- ライン: 85%以上
- ブランチ: 80%以上
- 関数: 90%以上
- ドメイン層は 100%を目指す

## テストの書き方

### 基本原則

1. **AAA パターン**: Arrange（準備）→ Act（実行）→ Assert（検証）
2. **1 テスト 1 検証**: 1 つのテストで確認することは 1 つだけ
3. **独立性**: 他のテストに依存しない
4. **再現性**: 何度実行しても同じ結果

### 命名規則

```typescript
describe("対象クラス/関数名", () => {
  describe("メソッド名", () => {
    it("should 期待する動作", () => {
      // テスト実装
    });
  });
});
```

### テストデータ

```typescript
// テストビルダーパターンを推奨
const workspace = TestBuilder.workspace().withName("Test Workspace").build();
```

## テスト環境

### データ管理戦略

1. **ユニットテスト**: インメモリ、モック使用
2. **統合テスト**: テスト用 DB（テスト毎にクリーンアップ）
3. **E2E テスト**: シードデータ使用

### モック戦略

- 外部サービスは必ずモック化
- DB はテスト用インスタンスを使用
- 時刻は固定値を使用

### ツール選定

- **ユニット/統合**: Vitest
- **E2E**: Playwright
- **パフォーマンス**: K6（必要時のみ）

## CI/CD 統合

### 実行タイミング

1. **プルリクエスト時**

   - ユニットテスト（必須）
   - 統合テスト（必須）
   - 関連する E2E テスト

2. **マージ時**
   - 全テストスイート実行
   - カバレッジレポート生成

### 品質ゲート

- [ ] 全テスト合格
- [ ] カバレッジ基準達成
- [ ] セキュリティスキャン合格
- [ ] パフォーマンス基準達成（主要機能のみ）

## フレイキーテスト対策

### よくある原因と対策

1. **タイミング依存**

   - 明示的な待機を使用
   - ポーリングで状態を確認

2. **データ競合**

   - ユニークなテストデータ使用
   - トランザクション分離

3. **外部依存**
   - 確実にモック化
   - タイムアウト設定

## ベストプラクティス

### DO

- テストファーストで開発
- 境界値を必ずテスト
- エラーケースを網羅
- リファクタリング前後でテスト実行

### DON'T

- 実装の詳細をテストしない
- private メソッドを直接テストしない
- 巨大なテストを書かない
- テストのためにプロダクトコードを変更しない

## チェックリスト

**新機能開発時**

- [ ] ユニットテストを書いた
- [ ] 統合テストが必要か検討した
- [ ] E2E テストが必要か検討した
- [ ] エッジケースをカバーした

**バグ修正時**

- [ ] バグを再現するテストを書いた
- [ ] 修正後、テストが通ることを確認した
- [ ] 関連する既存テストが壊れていない

**リリース前**

- [ ] 全テストスイートが通る
- [ ] カバレッジが基準を満たす
- [ ] パフォーマンステストが通る（該当する場合）
