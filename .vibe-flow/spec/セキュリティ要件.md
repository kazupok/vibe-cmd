# セキュリティ要件

## 概要

MaterCMSのセキュリティ要件は、OWASP Top 10 2021およびNIST Cybersecurity Frameworkに基づき、データの機密性、完全性、可用性を確保することを目的としています。

## 認証・認可

### 認証要件

1. **パスワードポリシー**

   - 最小14文字（NIST SP 800-63B準拠）
   - 辞書攻撃対策のためのパスワード強度チェック
   - pwned-passwordsデータベースとの照合
   - パスワード履歴20回分の再利用禁止
   - Argon2idによるハッシュ化（メモリ：64MB、反復：3、並列度：4）

2. **多要素認証（MFA）**

   - TOTP（RFC 6238準拠）
   - WebAuthn/FIDO2対応（推奨）
   - バックアップコード（8桁 x 10個）
   - デバイス記憶機能（最大30日間）
   - MFA強制化設定（ワークスペース単位）

3. **セッション管理**
   - JWT有効期限：15分（アクセストークン）
   - リフレッシュトークン：7日間（HTTPOnly, Secure, SameSite=Strict）
   - 同時セッション数制限：5デバイス
   - セッション固定攻撃対策
   - 自動ログアウト：非アクティブ8時間

```typescript
interface SessionConfig {
  accessToken: {
    expiresIn: '15m',
    algorithm: 'RS256',
    issuer: 'matercms.com',
    audience: 'api.matercms.com'
  },
  refreshToken: {
    expiresIn: '7d',
    rotation: true,
    reuseDetection: true
  },
  cookie: {
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000 // 7日
  }
}
```

### 認可要件

1. **ゼロトラストアクセス制御**

```typescript
enum Permission {
  // ワークスペース管理
  WORKSPACE_VIEW = "workspace:view",
  WORKSPACE_EDIT = "workspace:edit",
  WORKSPACE_DELETE = "workspace:delete",
  WORKSPACE_SETTINGS = "workspace:settings",

  // メンバー管理
  MEMBER_INVITE = "member:invite",
  MEMBER_REMOVE = "member:remove",
  MEMBER_EDIT_ROLE = "member:edit_role",
  MEMBER_VIEW_AUDIT = "member:view_audit",

  // Notion統合
  INTEGRATION_VIEW = "integration:view",
  INTEGRATION_MANAGE = "integration:manage",
  INTEGRATION_DELETE = "integration:delete",

  // API管理
  API_KEY_CREATE = "api_key:create",
  API_KEY_VIEW = "api_key:view",
  API_KEY_REVOKE = "api_key:revoke",

  // 監査・セキュリティ
  AUDIT_VIEW = "audit:view",
  SECURITY_MANAGE = "security:manage",
}
```

2. **最小権限の原則**
   | ロール | 権限セット |
   |--------|------------|
   | Owner | 全権限（削除含む） |
   | Admin | 管理権限（削除以外） |
   | Editor | 編集・統合管理 |
   | Viewer | 表示のみ |
   | API User | API操作のみ |

## データ保護

### 暗号化

1. **保存時の暗号化（Encryption at Rest）**
   - AES-256-GCM for アプリケーション層暗号化
   - ChaCha20-Poly1305 for 高性能要求領域
   - 暗号化対象：
     - Notion統合トークン
     - APIキー・シークレット
     - 個人識別情報（PII）
     - 機密設定情報

```typescript
interface EncryptedField {
  algorithm: "AES-256-GCM" | "ChaCha20-Poly1305";
  keyId: string; // キー識別子
  iv: string; // Base64
  authTag: string; // Base64（GCMの場合）
  encrypted: string; // Base64
  metadata?: {
    encryptedAt: string;
    version: number;
  };
}
```

2. **転送時の暗号化（Encryption in Transit）**

   - TLS 1.3必須（TLS 1.2以下は拒否）
   - HSTS有効化（max-age=31536000; includeSubDomains; preload）
   - Certificate Transparency対応
   - OCSP Stapling有効化
   - Perfect Forward Seccy（PFS）対応

3. **暗号化キー管理**
   - AWS KMS / HashiCorp Vault / Azure Key Vault使用
   - キーローテーション：30日ごと（自動化）
   - キーの階層構造（DEK/KEK分離）
   - HSM（Hardware Security Module）使用（本番環境）

```typescript
interface KeyManagementConfig {
  provider: "aws-kms" | "vault" | "azure-kv";
  rotation: {
    interval: "30d";
    automated: true;
    gracePeriod: "7d";
  };
  hierarchy: {
    kek: "arn:aws:kms:region:account:key/kek-id";
    dek: "application-managed";
  };
}
```

### データマスキング・匿名化

```typescript
// APIレスポンスでのマスキング
interface MaskedResponse {
  apiKey: string; // "mtr_1234************efgh"
  email: string; // "u***@example.com"
  ipAddress: string; // "192.168.xxx.xxx"
  phoneNumber: string; // "+81-xx-xxxx-1234"
}

// ログでの匿名化
interface AuditLog {
  userId: string; // ハッシュ化されたID
  action: string;
  timestamp: string;
  details: Record<string, unknown>; // PII除去済み
}
```

## APIセキュリティ

### レート制限・DDoS対策

```typescript
interface RateLimitTiers {
  // 段階的制限
  burst: {
    requests: 20;
    window: "1m";
  };
  sustained: {
    requests: 1000;
    window: "1h";
  };
  daily: {
    requests: 50000;
    window: "24h";
  };

  // ユーザータイプ別
  anonymous: {
    requests: 50;
    window: "1h";
  };
  authenticated: {
    requests: 2000;
    window: "1h";
  };
  premium: {
    requests: 10000;
    window: "1h";
  };

  // 特殊API
  notionSync: {
    requests: 3; // Notion APIの制限に合わせる
    window: "1s";
  };
  fileUpload: {
    requests: 10;
    window: "1m";
    sizeLimit: "10MB";
  };
}
```

### 入力検証・サニタイゼーション

1. **多層防御**

```typescript
// 1. スキーマレベル検証
const CreateWorkspaceSchema = z.object({
  name: z
    .string()
    .min(1, "Name is required")
    .max(100, "Name too long")
    .regex(/^[^<>\"'&]*$/, "Invalid characters"),

  slug: z
    .string()
    .min(3, "Slug too short")
    .max(50, "Slug too long")
    .regex(/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/, "Invalid slug format"),

  settings: z.record(z.unknown()).transform(sanitizeUserSettings),
});

// 2. ビジネスロジック検証
class WorkspaceValidator {
  static validateSlugUniqueness(slug: string): Promise<Result<void>>;
  static validateNameContent(name: string): Result<void>;
  static validateUserPermissions(userId: string): Promise<Result<void>>;
}
```

2. **SQLインジェクション対策**

   - Prisma ORMによる自動パラメータ化
   - 生SQLの完全禁止
   - 動的クエリの静的解析

3. **XSS対策**
   - Content Security Policy v3
   - React/Vue.jsの自動エスケープ
   - DOMPurifyによるHTMLサニタイゼーション

```typescript
const cspConfig = {
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.matercms.com"],
    styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
    imgSrc: ["'self'", "data:", "https:", "blob:"],
    connectSrc: [
      "'self'",
      "https://api.matercms.com",
      "wss://api.matercms.com",
    ],
    fontSrc: ["'self'", "https://fonts.gstatic.com"],
    objectSrc: ["'none'"],
    mediaSrc: ["'self'"],
    frameSrc: ["'none'"],
    reportUri: "/api/csp-report",
  },
};
```

### CORS・CSRF対策

```typescript
const corsConfig = {
  origin: (origin: string, callback: Function) => {
    const allowedOrigins = [
      /^https:\/\/.*\.matercms\.com$/,
      /^https:\/\/localhost:\d+$/, // 開発環境
      /^https:\/\/127\.0\.0\.1:\d+$/,
    ];

    const isAllowed =
      !origin || allowedOrigins.some((pattern) => pattern.test(origin));

    callback(null, isAllowed);
  },
  credentials: true,
  maxAge: 86400,
  methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
  allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With"],
};

// CSRF対策
const csrfConfig = {
  algorithm: "sha256",
  userInfo: true,
  cookieOptions: {
    httpOnly: true,
    secure: true,
    sameSite: "strict",
  },
};
```

## セキュリティヘッダー

```typescript
const securityHeaders = {
  "Strict-Transport-Security": "max-age=31536000; includeSubDomains; preload",
  "X-Content-Type-Options": "nosniff",
  "X-Frame-Options": "DENY",
  "X-XSS-Protection": "1; mode=block",
  "Referrer-Policy": "strict-origin-when-cross-origin",
  "Permissions-Policy": "camera=(), microphone=(), geolocation=()",
  "Cross-Origin-Embedder-Policy": "require-corp",
  "Cross-Origin-Opener-Policy": "same-origin",
  "Cross-Origin-Resource-Policy": "same-origin",
};
```

## 監査・ログ

### セキュリティ監査ログ

1. **記録対象イベント**

   - 認証関連（成功/失敗）
   - 権限変更・昇格
   - 機密データアクセス
   - 設定変更・削除
   - APIキー・トークン操作
   - 異常なアクセスパターン

2. **ログ形式（JSON構造化）**

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "eventId": "evt_7a8b9c0d1e2f3a4b",
  "severity": "HIGH",
  "category": "SECURITY",
  "action": "PRIVILEGE_ESCALATION",
  "actor": {
    "userId": "usr_hash_abc123",
    "sessionId": "ses_xyz789",
    "ipAddress": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "location": {
      "country": "JP",
      "city": "Tokyo"
    }
  },
  "target": {
    "resourceType": "workspace_membership",
    "resourceId": "mem_def456",
    "workspaceId": "ws_ghi789"
  },
  "changes": {
    "before": { "role": "editor" },
    "after": { "role": "admin" }
  },
  "metadata": {
    "requestId": "req_456def",
    "source": "web_app",
    "riskScore": 75
  }
}
```

3. **ログ保持・分析**
   - セキュリティログ：7年間（法的要件）
   - アクセスログ：1年間
   - デバッグログ：30日間
   - リアルタイム異常検知（機械学習ベース）

## 脆弱性管理

### 継続的セキュリティ監視

1. **自動脆弱性スキャン**

   - SAST（Static Application Security Testing）
   - DAST（Dynamic Application Security Testing）
   - SCA（Software Composition Analysis）
   - Container scanning（Trivy, Snyk）

2. **依存関係管理**

```yaml
# .github/workflows/security.yml
- name: Security audit
  run: |
    npm audit --audit-level high
    npx audit-ci --high
    docker run --rm -v "$PWD":/app clair-scanner

- name: CodeQL analysis
  uses: github/codeql-action/analyze@v2
  with:
    languages: javascript, typescript
```

3. **パッチ管理SLA**
   - Critical（CVSSスコア 9.0-10.0）：24時間以内
   - High（CVSSスコア 7.0-8.9）：72時間以内
   - Medium（CVSSスコア 4.0-6.9）：7日以内
   - Low（CVSSスコア 0.1-3.9）：30日以内

### ペネトレーションテスト

- **定期実施**：年2回
- **トリガー**：重要な機能追加、アーキテクチャ変更後
- **スコープ**：Web API、認証システム、インフラストラクチャ
- **レポート**：詳細な技術的検証結果と改善提案

## インシデント対応

### セキュリティインシデント対応計画

1. **検知・分類**

```typescript
enum IncidentSeverity {
  P1 = "CRITICAL", // サービス停止、大規模データ漏洩
  P2 = "HIGH", // 部分的機能停止、限定的データ漏洩
  P3 = "MEDIUM", // 性能劣化、セキュリティ設定不備
  P4 = "LOW", // 軽微な脆弱性、ログ異常
}

interface IncidentResponse {
  detection: "自動監視" | "ユーザー報告" | "内部発見";
  responseTime: {
    P1: "15分以内";
    P2: "1時間以内";
    P3: "4時間以内";
    P4: "24時間以内";
  };
}
```

2. **対応手順**
   - **即時対応**：脅威の隔離・無効化
   - **影響評価**：影響範囲とデータ特定
   - **証拠保全**：フォレンジック調査準備
   - **復旧**：サービス復旧と修正実装
   - **事後対応**：ユーザー通知、規制報告、改善策実施

## プライバシー・コンプライアンス

### データ保護規則準拠

1. **GDPR（EU一般データ保護規則）**

   - データポータビリティ（JSON形式エクスポート）
   - 忘れられる権利（30日以内完全削除）
   - データ処理の透明性（プライバシーダッシュボード）
   - DPO（データ保護責任者）指名

2. **CCPA（カリフォルニア州消費者プライバシー法）**

   - 個人情報の開示請求権
   - 削除請求権
   - 販売拒否権

3. **SOC 2 Type II準拠**
   - セキュリティ統制
   - 可用性統制
   - 処理の完全性
   - 機密性統制
   - プライバシー統制

### データ分類・保持

```typescript
interface DataClassification {
  public: {
    retention: "indefinite";
    encryption: false;
  };
  internal: {
    retention: "7年";
    encryption: "optional";
  };
  confidential: {
    retention: "3年";
    encryption: "required";
    access: "role-based";
  };
  restricted: {
    retention: "1年";
    encryption: "required";
    access: "explicit-approval";
    audit: "all-access";
  };
}
```

## セキュリティ監視・アラート

### SOC（Security Operations Center）

```typescript
interface SecurityMetrics {
  realtime: {
    activeSessions: number;
    failedLogins: number;
    anomalousRequests: number;
    threatScore: number;
  };
  alerts: {
    bruteForce: "CRITICAL";
    dataExfiltration: "CRITICAL";
    privilegeEscalation: "HIGH";
    suspiciousLogin: "MEDIUM";
  };
}
```

### 自動対応

- **IP ブロッキング**：異常なトラフィックパターン検知時
- **アカウント一時停止**：不正アクセス検知時
- **セッション無効化**：権限昇格攻撃検知時
- **管理者通知**：重要なセキュリティイベント発生時

## セキュリティチェックリスト

### デプロイ前チェック

- [ ] HTTPS強制（HSTS含む）
- [ ] セキュリティヘッダー設定完了
- [ ] CSP設定・テスト完了
- [ ] CSRF対策実装
- [ ] 入力検証・サニタイゼーション実装
- [ ] 認証・認可テスト実施
- [ ] 暗号化実装・テスト完了
- [ ] ログ・監査機能動作確認
- [ ] 脆弱性スキャン実施（問題なし）
- [ ] ペネトレーションテスト実施
- [ ] インシデント対応手順確認
- [ ] バックアップ・復旧テスト完了
- [ ] 監視・アラート設定完了

### 運用チェック（月次）

- [ ] セキュリティパッチ適用状況確認
- [ ] アクセス権限レビュー
- [ ] ログ分析・異常検知
- [ ] バックアップ整合性確認
- [ ] インシデント対応訓練実施
- [ ] 脆弱性スキャン結果レビュー
- [ ] セキュリティメトリクス分析
- [ ] 第三者監査結果対応
